# Copyright ¬© Mandala Consulting, LLC., 2025. All Rights Reserved. Created by Alexander Fields https://www.alexanderfields.me on 2025-10-17
name: Auto-Increment Version on PR

on:
  pull_request:
    branches: [master]
    types: [opened, synchronize, reopened]

jobs:
  version-check-and-increment:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git Identity
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '8.x'

      - name: Check and increment versions
        id: version-check
        run: |
          echo "Checking for code changes and version conflicts with master..."

          # Fetch master branch for comparison
          git fetch origin master:master

          # Define all project files and their directories to check
          declare -A PROJECTS=(
            ["MC.Logging/MandalaConsulting.Logging.csproj"]="MC.Logging"
            ["MC.Memory/MandalaConsulting.Memory.csproj"]="MC.Memory"
            ["MC.APIMiddlewares/MandalaConsulting.APIMiddlewares.csproj"]="MC.APIMiddlewares"
            ["MC.Repository.Mongo/MandalaConsulting.Repository.Mongo.csproj"]="MC.Repository.Mongo"
            ["MC.Objects/MandalaConsulting.Objects.csproj"]="MC.Objects"
            ["MC.Objects.API/MandalaConsulting.Objects.API.csproj"]="MC.Objects.API"
          )

          VERSIONS_UPDATED=0
          UPDATED_PROJECTS=""

          for PROJECT_PATH in "${!PROJECTS[@]}"; do
            PROJECT_DIR="${PROJECTS[$PROJECT_PATH]}"

            if [ ! -f "$PROJECT_PATH" ]; then
              echo "Warning: $PROJECT_PATH not found, skipping"
              continue
            fi

            echo ""
            echo "Checking $PROJECT_PATH:"

            # Check if there are any code changes in this project directory
            CODE_CHANGES=$(git diff --name-only master...HEAD -- "$PROJECT_DIR" | grep -v "\.csproj$" | wc -l)

            echo "  Code changes detected: $CODE_CHANGES file(s)"

            # Skip if no code changes (excluding .csproj file itself)
            if [ "$CODE_CHANGES" -eq 0 ]; then
              echo "  ‚úì No code changes - skipping version check"
              continue
            fi

            # Get version from PR branch
            PR_VERSION=$(grep -o '<Version>[^<]*</Version>' "$PROJECT_PATH" | sed 's/<Version>\(.*\)<\/Version>/\1/')

            if [ -z "$PR_VERSION" ]; then
              echo "  No <Version> tag found - skipping"
              continue
            fi

            # Get version from master branch
            MASTER_VERSION=$(git show master:"$PROJECT_PATH" 2>/dev/null | grep -o '<Version>[^<]*</Version>' | sed 's/<Version>\(.*\)<\/Version>/\1/' || echo "")

            if [ -z "$MASTER_VERSION" ]; then
              echo "  New project (not in master), version: $PR_VERSION"
              continue
            fi

            echo "  PR version:     $PR_VERSION"
            echo "  Master version: $MASTER_VERSION"

            # Compare versions - only increment if they match
            if [ "$PR_VERSION" = "$MASTER_VERSION" ]; then
              echo "  ‚ö†Ô∏è  Version not incremented despite code changes - auto-incrementing patch version"

              # Parse version components (assuming semantic versioning: MAJOR.MINOR.PATCH)
              IFS='.' read -r -a VERSION_PARTS <<< "$PR_VERSION"
              MAJOR="${VERSION_PARTS[0]}"
              MINOR="${VERSION_PARTS[1]}"
              PATCH="${VERSION_PARTS[2]}"

              # Increment patch version
              NEW_PATCH=$((PATCH + 1))
              NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"

              echo "  ‚úì New version: $NEW_VERSION"

              # Update the version in the csproj file
              sed -i "s|<Version>${PR_VERSION}</Version>|<Version>${NEW_VERSION}</Version>|g" "$PROJECT_PATH"

              VERSIONS_UPDATED=$((VERSIONS_UPDATED + 1))
              UPDATED_PROJECTS="${UPDATED_PROJECTS}\n- ${PROJECT_PATH}: ${PR_VERSION} ‚Üí ${NEW_VERSION}"
            else
              echo "  ‚úì Version already incremented"
            fi
          done

          echo ""
          echo "Summary: $VERSIONS_UPDATED project(s) had versions incremented"

          # Set outputs
          echo "versions_updated=$VERSIONS_UPDATED" >> $GITHUB_OUTPUT
          echo "updated_projects<<EOF" >> $GITHUB_OUTPUT
          echo -e "$UPDATED_PROJECTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Commit version changes
        if: steps.version-check.outputs.versions_updated != '0'
        run: |
          git add -A
          git commit -m "Auto-increment versions for PR to master"
          git push origin ${{ github.event.pull_request.head.ref }}

      - name: Comment on PR with version updates
        if: steps.version-check.outputs.versions_updated != '0'
        uses: actions/github-script@v8
        with:
          script: |
            const updatedProjects = `${{ steps.version-check.outputs.updated_projects }}`;
            const count = '${{ steps.version-check.outputs.versions_updated }}';

            const comment = `## üî¢ Version Auto-Increment

            **${count} project(s) had versions automatically incremented** to resolve conflicts with master branch:

            ${updatedProjects}

            These changes have been committed to this PR branch automatically.

            ---
            *ü§ñ Automated by version-increment workflow*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: No version updates needed
        if: steps.version-check.outputs.versions_updated == '0'
        run: |
          echo "‚úì All project versions are already different from master - no updates needed"
